<!doctype html>
<html lang="en" ng-strict-di>
    <head ng-controller="PageMetadata">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="/fonts/Lato/css/fonts.css" rel="stylesheet" type="text/css">
        <!-- @todo minify CSS -->
        <link rel="stylesheet" href="/css/style.css" ng-href="{{rtlEnabled ? '/css/rtl-style.css' : '/css/style.css'}}">
        <link rel="stylesheet" href="/css/vendor.css">
        <script src="/config.js"></script>

        <title ng-bind-template="{{pageTitle}} {{siteTitle}}"></title>
        <meta name="description" content="{{pageDescription}}">
        <meta name="keywords" content="{{pageKeywords}}">
        <meta name="robots" content="{{pageRobots}}">
        <base href="/">
    </head>

    <body ng-class="{ rtl : rtlEnabled }" class="layout-a mode-is-map" canvas>
        <div id="bootstrap-loading">
            <h1 class="beta"><i class="fa fa-refresh fa-4 fa-spin"></i></h1>
        </div>

        <div id="bootstrap-error" class="hidden">
            <div class="wrapper">
                <main class="page-content">
                    <div class="alert error">
                        <p>Sorry, something went wrong. Try reloading the page.</p>
                    </div>
                </main>
            </div>
        </div>

        <div id="bootstrap-app" class="hidden">

            <mode-bar></mode-bar>

            <mode-context></mode-context>

            <!-- Keep .canvas separate from ng-view otherwise offcanvas behaviour breaks on view change -->
            <main role="main">
                <tool-bar></tool-bar>
                <ng-include src="'templates/partials/toolbox.html'"></ng-include>

                <ng-view></ng-view>
            </main>

            <div class="wrapper">
                <ng-include src="'templates/partials/notification-system.html'"></ng-include>
            </div>

            <first-time-config></first-time-config>
        </div>

        <script src="/js/bundle.js"></script>

        <script type="text/javascript">
            if (window.ushahidi && window.ushahidi.doorbellEnabled) {
                window.doorbellOptions = {
                    tags: ['platform'],
                    appKey: window.ushahidi.doorbellAppKey,
                    properties: {
                        apiUrl: window.ushahidi.apiUrl
                    },
                    onShow: function () {
                        injector = angular.element(document).injector();
                        auth = injector.get('Authentication');
                        session = injector.get('Session');

                        if (auth && session) {
                            doorbell.setOption('email', session.getSessionDataEntry('email'));
                            doorbell.setProperty('loggedIn', auth.getLoginStatus());
                            doorbell.setProperty('role', session.getSessionDataEntry('role'));
                            doorbell.setProperty('realname', session.getSessionDataEntry('realname'));
                        }
                    }
                };
                (function(d, t) {
                    var g = d.createElement(t);g.id = 'doorbellScript';g.type = 'text/javascript';g.async = true;g.src = 'https://embed.doorbell.io/button/2005?t='+(new Date().getTime());(d.getElementsByTagName('head')[0]||d.getElementsByTagName('body')[0]).appendChild(g);
                }(document, 'script'));
            }
        </script>
        <!--
        Intercom integration
        -->
        <script type="text/javascript">
            (function(){
              var per_app_intercom_widget;

              function getAppId() {
                if (typeof window.intercomSettings !== 'undefined' &&
                  typeof(window.intercomSettings.app_id) !== 'undefined') {
                  return window.intercomSettings.app_id
                } else if (typeof window.analytics !== 'undefined' &&
                  typeof window.analytics._integrations !== 'undefined' &&
                  typeof analytics._integrations.Intercom !== 'undefined' &&
                  typeof analytics._integrations.Intercom.options !== 'undefined' &&
                  typeof analytics._integrations.Intercom.options.appId !== 'undefined') {
                  return analytics._integrations.Intercom.options.appId;
                } else {
                  return '';
                }
              }

              per_app_intercom_widget = 'https://widget.intercom.io/widget/' + getAppId();
              var script_tag = document.createElement('script');
              script_tag.type = 'text/javascript';
              script_tag.async = true;
              script_tag.src = per_app_intercom_widget;

              var existing_script = document.getElementsByTagName('script')[0];
              existing_script.parentNode.insertBefore(script_tag, existing_script);
            })();
        </script>
        <ng-include src="'templates/partials/intercom-system.html'"></ng-include>

        <script>
            if (window.ushahidi && window.ushahidi.gaEnabled) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', window.ushahidi.gaKey, 'auto');
                ga('send', 'pageview');
            }
        </script>
    </body>
</html>
