sudo: false
notifications:
  hipchat:
    rooms:
      secure: LW5XPoH6eOe/VPAVg1vOUk0jvWm662w8R30Wna0ZtcE2ZV40EHmyJfY7PLDA3/o/wme0vHhZh+cKWjbHbhF7RFrYAkNl6RLgmRkvMhaI/UKpztWRfIuopiJg2snHT0bH3nODm/2l9iSyhBc39lpxARFAhsUoN6j5zLyLyqfA7Xg=
    template:
    - '<a href="%{build_url}">%{repository}#%{build_number}</a> (%{branch} - <a href="%{compare_url}">%{commit}</a>
      : %{author}): %{message}'
    format: html
    notify: true
  slack:
    secure: MG3wEGLelQgasOVa5SyNbIfGWpvsmKZPF9moTrbLSrDgMptMxThSIDfVuAHvpBGsOw9o+izbTD26sbt1OQE9A9ipJfxUxZ+/LmYvaG0rSWvYEX9dIw9qp84pFyqwuO7nZlReeM7Ye9A2hYTBCZjqUsg8pwUlUUv065X3Qhp2IbY=
#addons:
#  sauce_connect: true
language: node_js
matrix:
  allow_failures:
  - node_js: stable
    env: TEST_SUITE=unit
  include:
  # Run everything with v8 (match production)
  - node_js: 8
    env: TEST_SUITE=lint
  - node_js: 8
    env: TEST_SUITE=unit
  - node_js: 8
    env: TEST_SUITE=unit
  - node_js: stable
    env: TEST_SUITE=unit
  - node_js: stable
    env: TEST_SUITE=ui
  fast_finish: true
cache:
  directories:
  - node_modules
services:
  - docker
before_install:
  - if [ "${TEST_SUITE}" == "ui" ]; then wget https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh; fi
  - if [ "${TEST_SUITE}" == "ui" ]; then chmod +x wait-for-it.sh; fi
  - if [ "${TEST_SUITE}" == "ui" ]; then git clone https://github.com/ushahidi/platform.git; fi
  - if [ "${TEST_SUITE}" == "ui" ]; then cd platform; fi
  - if [ "${TEST_SUITE}" == "ui" ]; then docker-compose up -d; fi
  - if [ "${TEST_SUITE}" == "ui" ]; then cd ..; fi
  - if [ "${TEST_SUITE}" == "ui" ]; then docker run -d -p 4444:4444 -p 5900:5900 -v /dev/shm:/dev/shm --name selenium selenium/standalone-chrome-debug; fi
  - if [ "${TEST_SUITE}" == "ui" ]; then ./wait-for-it.sh -t 120 172.17.0.1:80; fi
  - if [ "${TEST_SUITE}" == "ui" ]; then cp test/ui/ui-tests.env .env; fi
install:
- npm install -g gulp
- npm install
before_script:
- test/pre_test.sh
script:
- if [ "${TEST_SUITE}" == "ui" ]; then (gulp &); fi
- if [ "${TEST_SUITE}" == "ui" ]; then ./wait-for-it.sh -t 120 172.17.0.1:3000; fi
- test/test.sh
after_script:
- if [ "${TEST_SUITE}" == "unit" ]; then gulp send-stats-to-coveralls; fi
### Deploy files now generated by Codeship
# before_deploy:
# - gulp release --version-suffix=${TRAVIS_TAG:-$TRAVIS_COMMIT}
# deploy:
# - provider: releases
#   api_key:
#     secure: Txqa+XwZOOdAaxRckHGXSCkT7GEUh4R6R0MtTu8otA1Vv2/W5qTICuFnaEzV/FVWrSzYbMwM+mAFHQ1L8SXOnAvbSFwnjaOjIvaEUESItkSITDXncTJItJatzMUXT0SjRTm4Jy6LQ0Pq0qXxfWD6DzsWxPVPsthprb+aEzS0/m8=
#   file: build/*
#   file_glob: true
#   skip_cleanup: true
#   on:
#     repo: ushahidi/platform-client
#     node: 0.12
#     tags: true
#     all_branches: true
